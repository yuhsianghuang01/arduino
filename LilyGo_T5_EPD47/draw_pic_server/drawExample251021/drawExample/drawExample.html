<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EPD Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; padding: 10px; background: #f5f5f5; }
    button { margin:5px; padding:10px; font-size:16px; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { opacity: 0.8; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .upload, .text-control { margin-top:20px; padding:15px; border:1px solid #ccc; border-radius:8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .form-row { margin:10px 0; display: flex; align-items: center; flex-wrap: wrap; }
    label { display:inline-block; width:80px; font-weight: bold; margin-right: 10px; }
    input[type="text"], input[type="number"] { padding:8px; margin:5px; border: 1px solid #ddd; border-radius: 4px; }
    input[type="range"] { width:200px; margin: 0 10px; }
    input[type="file"] { padding: 8px; border: 2px dashed #ccc; border-radius: 4px; width: 100%; }
    input[type="file"]:hover { border-color: #4CAF50; }
    .color-value { font-weight:bold; color: #2196F3; margin-left: 10px; }
    
    /* æ™ºèƒ½åœ–ç‰‡æ§åˆ¶å°ˆç”¨æ¨£å¼ */
    .upload h3 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 8px; }
    .upload h4 { color: #666; margin: 20px 0 10px 0; }
    #imagePreviewCanvas { 
      max-width: 100%; 
      height: auto; 
      border: 2px solid #333; 
      border-radius: 4px;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #positionInfo { 
      font-family: monospace; 
      background: #f0f0f0; 
      padding: 8px; 
      border-radius: 4px; 
      margin-top: 10px;
      border-left: 4px solid #2196F3;
    }
    #uploadProgress {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    #progressBar {
      background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
      height: 24px;
      border-radius: 12px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    #progressBar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 33%, rgba(255,255,255,.3) 33%, rgba(255,255,255,.3) 66%, transparent 66%);
      animation: progressShine 2s infinite;
    }
    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    small { color: #666; font-style: italic; margin-left: 10px; }
    
    /* æŒ‰éˆ•æ¨£å¼å¢å¼· */
    button[onclick*="fit"] { background: #2196F3; color: white; }
    button[onclick*="keep"] { background: #FF9800; color: white; }
    button[onclick*="center"] { background: #9C27B0; color: white; }
    button[onclick*="invert"] { background: #607D8B; color: white; }
    button[onclick*="reset"] { background: #795548; color: white; }
    #sendImageBtn { 
      background: linear-gradient(45deg, #4CAF50, #45a049); 
      color: white; 
      font-weight: bold;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease;
    }
    #sendImageBtn:hover:not(:disabled) { 
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
    }
    
    /* Canvas æ‰‹å¯«æ¿æ¨£å¼ */
    .canvas-container { 
      margin: 20px 0; 
      padding: 15px; 
      border: 1px solid #ccc; 
      border-radius: 5px;
      text-align: center;
    }
    #drawingCanvas {
      border: 2px solid #333;
      cursor: crosshair;
      width: 100%;
      max-width: 800px;
      background-color: white;
    }
    .canvas-controls {
      margin: 10px 0;
    }
    .canvas-controls button {
      margin: 2px 5px;
      padding: 8px 15px;
    }
    
    /* åœ–ç‰‡è½‰æ›å™¨æ¨£å¼ */
    .converter-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #e9ecef;
    }
    
    .size-settings {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #2196F3;
    }
    
    .size-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    
    .size-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .size-select {
      padding: 6px 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background: white;
      min-width: 70px;
    }
    
    .multiply-symbol {
      font-size: 18px;
      font-weight: bold;
      color: #6c757d;
    }
    
    .preset-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }
    
    .preset-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: background 0.3s;
    }
    
    .preset-btn:hover {
      background: #5a6268;
    }
    
    .preset-btn.active {
      background: #4CAF50;
    }
    
    .file-input-wrapper {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .file-input-wrapper:hover {
      background: #45a049;
    }
    
    .converter-textarea {
      width: 100%;
      height: 150px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      resize: vertical;
      background: #fafafa;
    }
    
    .converter-info {
      margin: 10px 0;
      padding: 10px;
      background: #fff3cd;
      border-radius: 4px;
      border-left: 4px solid #ffc107;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h2>EPD Web Controller - æ¸¬è©¦ç‰ˆæœ¬</h2>
  <p style="color: #666; font-style: italic;">é€™æ˜¯å¾ Arduino ç¨‹å¼ä¸­æå–çš„å®Œæ•´ç¶²é å…§å®¹ï¼Œç”¨æ–¼æ¸¬è©¦å„é …åŠŸèƒ½ã€‚</p>
  
  <!-- åŸºæœ¬æ§åˆ¶æŒ‰éˆ• -->
  <div class="text-control">
    <h3>åŸºæœ¬æ§åˆ¶</h3>
    <button onclick="alert('æ¸…é™¤è¢å¹•åŠŸèƒ½ - å¯¦éš›ä½¿ç”¨éœ€é€£æ¥ Arduino')">Clear Screen</button>
    <button onclick="alert('éš¨æ©Ÿç•«ç·šåŠŸèƒ½ - å¯¦éš›ä½¿ç”¨éœ€é€£æ¥ Arduino')">Draw Random Line</button>
    <button onclick="alert('éš¨æ©Ÿç•«çŸ©å½¢åŠŸèƒ½ - å¯¦éš›ä½¿ç”¨éœ€é€£æ¥ Arduino')">Draw Random Rect</button>
    <button onclick="alert('éš¨æ©Ÿç•«åœ“åŠŸèƒ½ - å¯¦éš›ä½¿ç”¨éœ€é€£æ¥ Arduino')">Draw Random Circle</button>
  </div>

  <!-- æ‰‹å¯«ç¹ªåœ–æ¿ -->
  <div class="canvas-container">
    <h3>æ‰‹å¯«ç¹ªåœ–æ¿ (å°å°ºå¯¸æ¸¬è©¦ç‰ˆ)</h3>
    <p>æ³¨æ„ï¼šä½¿ç”¨100x60å°å°ºå¯¸ç¢ºä¿æ•¸æ“šå‚³è¼¸ç©©å®šï¼Œå°‡è‡ªå‹•ç¸®æ”¾åˆ°EPD</p>
    <canvas id="drawingCanvas" width="100" height="60"></canvas>
    <div class="canvas-controls">
      <button onclick="clearCanvas()">æ¸…é™¤ç•«å¸ƒ</button>
      <button onclick="sendCanvasToEPD()">åŒæ­¥åˆ°EPD</button>
      <label>ç­†åˆ·å¤§å°:</label>
      <input type="range" id="brushSize" min="1" max="20" value="3" oninput="updateBrushSize()">
      <span class="color-value" id="brushSizeValue">3</span>
      <label>ç­†åˆ·é¡è‰²:</label>
      <input type="range" id="brushColor" min="0" max="15" value="0" oninput="updateBrushColor()">
      <span class="color-value" id="brushColorValue">0 (é»‘è‰²)</span>
    </div>
  </div>

  <!-- æ–‡å­—æ§åˆ¶ -->
  <div class="text-control">
    <h3>æ–‡å­—æ§åˆ¶</h3>
    <div class="form-row">
      <label>æ–‡å­—:</label>
      <input type="text" id="text" placeholder="è¼¸å…¥æ–‡å­—" value="Hello EPD">
    </div>
    <div class="form-row">
      <label>Xåº§æ¨™:</label>
      <input type="number" id="x" min="0" max="540" value="50">
      <label>Yåº§æ¨™:</label>
      <input type="number" id="y" min="0" max="960" value="50">
    </div>
    <div class="form-row">
      <label>å­—é«”å¤§å°:</label>
      <input type="range" id="fontSize" min="1" max="100" value="2" oninput="updateFontSizeValue()">
      <span class="color-value" id="fontSizeValue">2</span>
    </div>
    <div class="form-row">
      <label>æ–‡å­—é¡è‰²:</label>
      <input type="range" id="textColor" min="0" max="15" value="0" oninput="updateTextColorValue()">
      <span class="color-value" id="textColorValue">0 (é»‘è‰²)</span>
    </div>
    <div class="form-row">
      <label>èƒŒæ™¯é¡è‰²:</label>
      <input type="range" id="bgColor" min="0" max="16" value="16" oninput="updateBgColorValue()">
      <span class="color-value" id="bgColorValue">é€æ˜</span>
    </div>
    
    <div class="form-row">
      <label>é è¨­æ¨£å¼:</label>
      <button onclick="setStyle('title')" style="margin:2px; padding:5px;">æ¨™é¡Œ</button>
      <button onclick="setStyle('normal')" style="margin:2px; padding:5px;">æ­£æ–‡</button>
      <button onclick="setStyle('highlight')" style="margin:2px; padding:5px;">å¼·èª¿</button>
      <button onclick="setStyle('subtitle')" style="margin:2px; padding:5px;">å‰¯æ¨™é¡Œ</button>
    </div>
    
    <button onclick="drawText()">ç¹ªè£½æ–‡å­—</button>
    
    <h4>å¤šè¡Œæ–‡å­—</h4>
    <div class="form-row">
      <label>å¤šè¡Œæ–‡å­—:</label>
      <textarea id="multiText" placeholder="è¼¸å…¥å¤šè¡Œæ–‡å­—ï¼Œç”¨åˆ†è™Ÿ(;)åˆ†éš”" rows="3" style="width:300px;">ç¬¬ä¸€è¡Œæ–‡å­—;ç¬¬äºŒè¡Œæ–‡å­—;ç¬¬ä¸‰è¡Œæ–‡å­—</textarea>
    </div>
    <div class="form-row">
      <label>èµ·å§‹X:</label>
      <input type="number" id="startX" min="0" max="540" value="50">
      <label>èµ·å§‹Y:</label>
      <input type="number" id="startY" min="0" max="960" value="100">
    </div>
    <div class="form-row">
      <label>è¡Œé«˜:</label>
      <input type="number" id="lineHeight" min="10" max="100" value="25">
    </div>
    <button onclick="drawMultiText()">ç¹ªè£½å¤šè¡Œæ–‡å­—</button>
  </div>

  <!-- é€²éšç¹ªåœ–æ§åˆ¶ -->
  <div class="text-control">
    <h3>é€²éšç¹ªåœ–æ§åˆ¶</h3>
    
    <h4>ç•«ç·šæ§åˆ¶</h4>
    <div class="form-row">
      <label>èµ·é»X:</label>
      <input type="number" id="lineX1" min="0" max="540" value="50">
      <label>èµ·é»Y:</label>
      <input type="number" id="lineY1" min="0" max="960" value="50">
    </div>
    <div class="form-row">
      <label>çµ‚é»X:</label>
      <input type="number" id="lineX2" min="0" max="540" value="200">
      <label>çµ‚é»Y:</label>
      <input type="number" id="lineY2" min="0" max="960" value="100">
    </div>
    <div class="form-row">
      <label>ç·šæ¢é¡è‰²:</label>
      <input type="range" id="lineColor" min="0" max="15" value="0" oninput="updateLineColorValue()">
      <span class="color-value" id="lineColorValue">0 (é»‘è‰²)</span>
    </div>
    <div class="form-row">
      <label>ç·šæ¢ç²—ç´°:</label>
      <input type="range" id="lineThickness" min="1" max="20" value="1" oninput="updateLineThicknessValue()">
      <span class="color-value" id="lineThicknessValue">1</span>
    </div>
    <button onclick="drawLineAdvanced()">ç¹ªè£½ç·šæ¢</button>

    <h4>ç•«åœ“æ§åˆ¶</h4>
    <div class="form-row">
      <label>åœ“å¿ƒX:</label>
      <input type="number" id="circleX" min="0" max="540" value="200">
      <label>åœ“å¿ƒY:</label>
      <input type="number" id="circleY" min="0" max="960" value="200">
    </div>
    <div class="form-row">
      <label>åŠå¾‘:</label>
      <input type="number" id="circleRadius" min="1" max="500" value="50">
    </div>
    <div class="form-row">
      <label>å¤–æ¡†:</label>
      <input type="checkbox" id="circleBorder" checked>
      <label>å¤–æ¡†é¡è‰²:</label>
      <input type="range" id="circleBorderColor" min="0" max="15" value="0" oninput="updateCircleBorderColorValue()">
      <span class="color-value" id="circleBorderColorValue">0 (é»‘è‰²)</span>
    </div>
    <div class="form-row">
      <label>å¤–æ¡†ç²—ç´°:</label>
      <input type="range" id="circleBorderThickness" min="1" max="10" value="1" oninput="updateCircleBorderThicknessValue()">
      <span class="color-value" id="circleBorderThicknessValue">1</span>
    </div>
    <div class="form-row">
      <label>å¡«æ»¿:</label>
      <input type="checkbox" id="circleFill">
      <label>å¡«å……é¡è‰²:</label>
      <input type="range" id="circleFillColor" min="0" max="15" value="15" oninput="updateCircleFillColorValue()">
      <span class="color-value" id="circleFillColorValue">15 (ç™½è‰²)</span>
    </div>
    <button onclick="drawCircleAdvanced()">ç¹ªè£½åœ“å½¢</button>

    <h4>ç•«çŸ©å½¢æ§åˆ¶</h4>
    <div class="form-row">
      <label>å·¦ä¸ŠX:</label>
      <input type="number" id="rectX" min="0" max="540" value="100">
      <label>å·¦ä¸ŠY:</label>
      <input type="number" id="rectY" min="0" max="960" value="150">
    </div>
    <div class="form-row">
      <label>å¯¬åº¦:</label>
      <input type="number" id="rectWidth" min="1" max="540" value="100">
      <label>é«˜åº¦:</label>
      <input type="number" id="rectHeight" min="1" max="960" value="80">
    </div>
    <div class="form-row">
      <label>å¤–æ¡†:</label>
      <input type="checkbox" id="rectBorder" checked>
      <label>å¤–æ¡†é¡è‰²:</label>
      <input type="range" id="rectBorderColor" min="0" max="15" value="0" oninput="updateRectBorderColorValue()">
      <span class="color-value" id="rectBorderColorValue">0 (é»‘è‰²)</span>
    </div>
    <div class="form-row">
      <label>å¤–æ¡†ç²—ç´°:</label>
      <input type="range" id="rectBorderThickness" min="1" max="10" value="1" oninput="updateRectBorderThicknessValue()">
      <span class="color-value" id="rectBorderThicknessValue">1</span>
    </div>
    <div class="form-row">
      <label>å¡«æ»¿:</label>
      <input type="checkbox" id="rectFill">
      <label>å¡«å……é¡è‰²:</label>
      <input type="range" id="rectFillColor" min="0" max="15" value="15" oninput="updateRectFillColorValue()">
      <span class="color-value" id="rectFillColorValue">15 (ç™½è‰²)</span>
    </div>
    <button onclick="drawRectAdvanced()">ç¹ªè£½çŸ©å½¢</button>
  </div>

  <!-- åœ–ç‰‡ä¸Šå‚³ -->
  <div class="upload">
    <h3>Upload 1-bit or 2-bit RAW Image</h3>
    <p>Size: 540x960 (bytes: 259200)</p>
    <form method="POST" action="/upload" enctype="multipart/form-data">
      <input type="file" name="image" accept=".bin,.raw">
      <input type="submit" value="Upload">
    </form>
  </div>

  <!-- EPD åœ–ç‰‡è½‰æ›å™¨ -->
  <div class="text-control">
    <h3>ğŸ–¼ï¸ EPD åœ–ç‰‡è½‰æ›å™¨</h3>
    <p>å°‡ä»»ä½•åœ–ç‰‡è½‰æ›ç‚º EPD å¯ç”¨çš„ç°éšæ•¸æ“šï¼Œæ”¯æ´å‹•æ…‹å°ºå¯¸èª¿æ•´</p>
    
    <div class="converter-container">
      <div class="size-settings">
        <h4>ğŸ“ åœ–ç‰‡å°ºå¯¸è¨­å®š</h4>
        <div class="size-controls">
          <div class="size-input-group">
            <label>å¯¬åº¦:</label>
            <select id="widthSelect" class="size-select">
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="128">128</option>
              <option value="200">200</option>
              <option value="320">320</option>
              <option value="480" selected>480</option>
              <option value="540">540</option>
              <option value="600">600</option>
              <option value="800">800</option>
              <option value="960">960</option>
            </select>
          </div>
          
          <span class="multiply-symbol">Ã—</span>
          
          <div class="size-input-group">
            <label>é«˜åº¦:</label>
            <select id="heightSelect" class="size-select">
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="128">128</option>
              <option value="200">200</option>
              <option value="320">320</option>
              <option value="480">480</option>
              <option value="540">540</option>
              <option value="600">600</option>
              <option value="800" selected>800</option>
              <option value="960">960</option>
            </select>
          </div>
        </div>
        
        <div class="preset-buttons">
          <button class="preset-btn" onclick="setPresetSize(64, 64)">64Ã—64</button>
          <button class="preset-btn" onclick="setPresetSize(128, 128)">128Ã—128</button>
          <button class="preset-btn" onclick="setPresetSize(320, 240)">320Ã—240</button>
          <button class="preset-btn active" onclick="setPresetSize(480, 800)">480Ã—800</button>
          <button class="preset-btn" onclick="setPresetSize(540, 960)">540Ã—960</button>
          <button class="preset-btn" onclick="setPresetSize(800, 600)">800Ã—600</button>
        </div>
      </div>
      
      <div style="text-align: center; margin: 15px 0;">
        <div class="file-input-wrapper" onclick="document.getElementById('imageInput').click()">
          <input type="file" id="imageInput" accept="image/*" style="display: none;">
          ğŸ–¼ï¸ é¸æ“‡åœ–ç‰‡æª”æ¡ˆ
        </div>
      </div>
      
      <div class="converter-info">
        <strong>ä½¿ç”¨èªªæ˜ï¼š</strong>
        <ul style="margin: 5px 0; padding-left: 20px;">
          <li>é¸æ“‡åœ–ç‰‡å¾Œæœƒè‡ªå‹•è½‰æ›ç‚ºæŒ‡å®šå°ºå¯¸çš„ç°éšåœ–ç‰‡</li>
          <li>ç°éšå€¼ç¯„åœï¼š0-15 (0=é»‘è‰², 15=ç™½è‰²)</li>
          <li>åœ¨ä¸‹æ–¹æ•¸æ“šæ¡†é›™æ“Šå¯è¤‡è£½æ‰€æœ‰æ•¸æ“š</li>
          <li>å¯ç›´æ¥å°‡æ•¸æ“šè²¼åˆ° "ç°éšåœ–ç‰‡æ•¸æ“šå‚³é€" åŠŸèƒ½ä½¿ç”¨</li>
        </ul>
      </div>
      
      <div style="text-align: center; margin: 20px 0; border: 2px dashed #ddd; padding: 15px; border-radius: 6px; background: white;">
        <canvas id="imageCanvas" width="480" height="800" style="max-width: 100%; border: 1px solid #ccc; background: #f9f9f9;"></canvas>
        <div id="canvasInfo" style="margin-top: 10px; color: #666; font-size: 12px;">
          è«‹å…ˆé¸æ“‡åœ–ç‰‡æª”æ¡ˆ
        </div>
      </div>
      
      <div style="margin-top: 15px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;" id="dataLabel">
          ç°éšæ•¸æ“š (480Ã—800 = 384,000 å€‹å€¼)ï¼š
        </label>
        <textarea id="converterDataTextarea" class="converter-textarea" placeholder="è½‰æ›å¾Œçš„ç°éšæ•¸æ“šå°‡é¡¯ç¤ºåœ¨é€™è£¡..." readonly></textarea>
        <div style="margin-top: 5px; font-size: 11px; color: #666; font-style: italic;">
          ğŸ’¡ é›™æ“Šæ–‡å­—æ¡†å¯è¤‡è£½æ‰€æœ‰æ•¸æ“šåˆ°å‰ªè²¼ç°¿
        </div>
      </div>
      
      <div style="margin-top: 15px; text-align: center;">
        <button onclick="resetConverter()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">é‡ç½®</button>
        <button onclick="downloadConverterData()" style="background: #17a2b8; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">ä¸‹è¼‰æ•¸æ“š</button>
      </div>
    </div>
  </div>

  <!-- ç°éšåœ–ç‰‡æ•¸æ“šå‚³é€ -->
  <div class="text-control">
    <h3>ç°éšåœ–ç‰‡æ•¸æ“šå‚³é€</h3>
    <p>å¾å¤–éƒ¨å·¥å…·ç”Ÿæˆçš„ç°éšæ•¸æ“š (0-15ï¼Œé€—è™Ÿåˆ†éš”)</p>
    <div class="form-row">
      <label>Xåº§æ¨™:</label>
      <input type="number" id="grayscaleX" min="0" max="540" value="0">
      <label>Yåº§æ¨™:</label>
      <input type="number" id="grayscaleY" min="0" max="960" value="0">
    </div>
    <div class="form-row">
      <label>åœ–ç‰‡å¯¬åº¦:</label>
      <input type="number" id="grayscaleWidth" min="1" max="540" value="100">
      <label>åœ–ç‰‡é«˜åº¦:</label>
      <input type="number" id="grayscaleHeight" min="1" max="960" value="100">
    </div>
    <div class="form-row">
      <label>ç°éšæ•¸æ“š:</label>
      <textarea id="grayscaleData" placeholder="è²¼å…¥ç°éšæ•¸æ“šï¼Œæ ¼å¼: 15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,..." 
      rows="6" style="width:100%; max-width:600px; font-family:monospace;"></textarea>
    </div>
    <div class="form-row">
      <button onclick="sendGrayscaleData()" style="background-color:#4CAF50; color:white; padding:10px 20px; font-size:16px;">å‚³é€ç°éšåœ–ç‰‡è³‡æ–™</button>
      <button onclick="clearGrayscaleData()" style="margin-left:10px;">æ¸…é™¤æ•¸æ“š</button>
    </div>
    <div class="form-row">
      <small>ğŸ’¡ æç¤º: å¾å¤–éƒ¨åœ–ç‰‡è½‰æ›å·¥å…·è¤‡è£½æ•¸æ“šï¼Œè¨­å®šå¥½ä½ç½®å’Œå°ºå¯¸å¾Œé»æ“Šå‚³é€</small>
    </div>
  </div>

  <!-- æ™ºèƒ½åœ–ç‰‡æ§åˆ¶ä¸Šå‚³ç³»çµ± -->
  <div class="upload">
    <h3>ğŸ–¼ï¸ æ™ºèƒ½åœ–ç‰‡æ§åˆ¶å™¨</h3>
    
    <!-- åœ–ç‰‡é¸æ“‡å€ -->
    <div class="form-row">
      <label>é¸æ“‡åœ–ç‰‡:</label>
      <input type="file" id="uploadImageFile" accept="image/*" onchange="previewUploadedImage()">
      <small>æ”¯æ´ JPGã€PNGã€GIFã€BMP ç­‰æ ¼å¼</small>
    </div>
    
    <!-- åœ–ç‰‡è³‡è¨Šé¡¯ç¤º -->
    <div id="imageInfo" style="margin: 10px 0; color: #666; font-size: 14px;">
      å°šæœªé¸æ“‡åœ–ç‰‡
    </div>
    
    <!-- åœ–ç‰‡é è¦½å€ -->
    <div id="imagePreview" style="display:none;">
      <h4>é è¦½æ•ˆæœ</h4>
      <div style="text-align: center; margin: 15px 0;">
        <canvas id="imagePreviewCanvas" style="border: 2px solid #333; background: white;"></canvas>
        <div id="positionInfo" style="margin-top: 10px; color: #666; font-size: 12px;">
          ä½ç½®è³‡è¨Šå°‡åœ¨æ­¤é¡¯ç¤º
        </div>
      </div>
    </div>
    
    <!-- ä½ç½®å’Œå°ºå¯¸æ§åˆ¶ -->
    <div id="positionControls" style="display:none;">
      <h4>ğŸ“ ä½ç½®å’Œå°ºå¯¸æ§åˆ¶</h4>
      <div class="form-row">
        <label>Xåº§æ¨™:</label>
        <input type="number" id="imgX" min="0" max="540" value="0" step="1" onchange="updateImagePreview()">
        <label>Yåº§æ¨™:</label>
        <input type="number" id="imgY" min="0" max="960" value="0" step="1" onchange="updateImagePreview()">
      </div>
      <div class="form-row">
        <label>å¯¬åº¦:</label>
        <input type="number" id="imgWidth" min="1" max="540" value="200" step="1" onchange="updateImagePreview()">
        <label>é«˜åº¦:</label>
        <input type="number" id="imgHeight" min="1" max="960" value="200" step="1" onchange="updateImagePreview()">
      </div>
      <div class="form-row">
        <button onclick="fitToScreen()">ğŸ“± é©æ‡‰è¢å¹•</button>
        <button onclick="keepAspectRatio()">ğŸ“ ä¿æŒæ¯”ä¾‹</button>
        <button onclick="centerImage()">ğŸ¯ ç½®ä¸­</button>
      </div>
    </div>
    
    <!-- æ•ˆæœæ§åˆ¶ -->
    <div id="effectControls" style="display:none;">
      <h4>ğŸ¨ æ•ˆæœæ§åˆ¶</h4>
      <div class="form-row">
        <label>å°æ¯”åº¦:</label>
        <input type="range" id="contrast" min="0" max="200" value="100" step="5" oninput="updateContrast()">
        <span class="color-value" id="contrastValue">100%</span>
      </div>
      <div class="form-row">
        <label>äº®åº¦:</label>
        <input type="range" id="brightness" min="-100" max="100" value="0" step="5" oninput="updateBrightness()">
        <span class="color-value" id="brightnessValue">0</span>
      </div>
      <div class="form-row">
        <label>ç°éšç´šæ•¸:</label>
        <input type="range" id="grayLevels" min="2" max="16" value="16" step="1" oninput="updateGrayLevels()">
        <span class="color-value" id="grayLevelsValue">16ç´š</span>
      </div>
      <div class="form-row">
        <button onclick="invertColors()">ğŸ”„ åç›¸</button>
        <button onclick="resetEffects()">â†º é‡ç½®æ•ˆæœ</button>
      </div>
    </div>
    
    <!-- ç™¼é€æ§åˆ¶ -->
    <div class="form-row" style="margin-top: 20px;">
      <button onclick="sendImageToEPD()" id="sendImageBtn" disabled style="background: #4CAF50; color: white; font-size: 16px; padding: 12px 24px;">
        ğŸš€ ç™¼é€åœ–ç‰‡åˆ° EPD
      </button>
    </div>
    
    <!-- é€²åº¦é¡¯ç¤º -->
    <div id="uploadProgress" style="display:none; margin-top: 15px;">
      <div style="background: #f0f0f0; border-radius: 10px; padding: 10px;">
        <div>è™•ç†é€²åº¦ï¼š<span id="progressText">0%</span></div>
        <div style="background: #ddd; border-radius: 5px; margin-top: 5px;">
          <div id="progressBar" style="background: #4CAF50; height: 20px; border-radius: 5px; width: 0%; transition: width 0.3s;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç”±æ–¼é€™æ˜¯æ¸¬è©¦ç‰ˆæœ¬ï¼Œæ‰€æœ‰ç¶²è·¯è«‹æ±‚åŠŸèƒ½æœƒä»¥ alert æç¤ºä»£æ›¿
    console.log('EPD Controller Test Page Loaded');
    
    // æ¸¬è©¦ç”¨å‡½æ•¸ï¼Œé¡¯ç¤ºåŠŸèƒ½èªªæ˜
    function showTestAlert(feature) {
      alert('æ¸¬è©¦æ¨¡å¼ï¼š' + feature + '\nå¯¦éš›ä½¿ç”¨éœ€è¦é€£æ¥åˆ° Arduino EPD æ§åˆ¶å™¨');
    }
    
    // Canvas ç¹ªåœ–è®Šæ•¸
    let canvas = null;
    let ctx = null;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let currentBrushSize = 3;
    let currentBrushColor = 0;
    
    // æ™ºèƒ½åœ–ç‰‡æ§åˆ¶è®Šæ•¸
    var smartImageData = null;
    var originalImage = null;
    
    // åˆå§‹åŒ– Canvas
    function initCanvas() {
      canvas = document.getElementById('drawingCanvas');
      if (canvas) {
        ctx = canvas.getContext('2d');
        
        // è¨­ç½®ç¹ªåœ–å±¬æ€§
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        
        // æ·»åŠ äº‹ä»¶ç›£è½å™¨
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
      }
    }
    
    function startDrawing(e) {
      isDrawing = true;
      [lastX, lastY] = getMousePos(e);
    }
    
    function draw(e) {
      if (!isDrawing) return;
      
      const [currentX, currentY] = getMousePos(e);
      
      ctx.strokeStyle = getCanvasColor(currentBrushColor);
      ctx.lineWidth = currentBrushSize;
      
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(currentX, currentY);
      ctx.stroke();
      
      [lastX, lastY] = [currentX, currentY];
    }
    
    function stopDrawing() {
      isDrawing = false;
    }
    
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      
      return [
        (e.clientX - rect.left) * scaleX,
        (e.clientY - rect.top) * scaleY
      ];
    }
    
    function getCanvasColor(colorValue) {
      const gray = Math.round(colorValue * 255 / 15);
      return `rgb(${gray}, ${gray}, ${gray})`;
    }
    
    function clearCanvas() {
      if (ctx) {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }
    
    function sendCanvasToEPD() {
      showTestAlert('Canvas åŒæ­¥åˆ° EPD åŠŸèƒ½');
    }
    
    // é¡è‰²åç¨±å‡½æ•¸
    function getColorName(color) {
      if (color == 0) return 'é»‘è‰²';
      else if (color <= 3) return 'æ·±ç°';
      else if (color <= 7) return 'ä¸­ç°';
      else if (color <= 11) return 'æ·ºç°';
      else return 'ç™½è‰²';
    }
    
    // æ›´æ–°å‡½æ•¸
    function updateBrushSize() {
      currentBrushSize = document.getElementById('brushSize').value;
      document.getElementById('brushSizeValue').textContent = currentBrushSize;
    }
    
    function updateBrushColor() {
      currentBrushColor = document.getElementById('brushColor').value;
      const colorName = getColorName(currentBrushColor);
      document.getElementById('brushColorValue').textContent = currentBrushColor + ' (' + colorName + ')';
    }
    
    function updateFontSizeValue() {
      const size = document.getElementById('fontSize').value;
      document.getElementById('fontSizeValue').textContent = size + ' (åƒç´ å€æ•¸)';
    }
    
    function updateTextColorValue() {
      const color = document.getElementById('textColor').value;
      const colorName = getColorName(color);
      document.getElementById('textColorValue').textContent = color + ' (' + colorName + ')';
    }
    
    function updateBgColorValue() {
      const color = document.getElementById('bgColor').value;
      let colorName;
      if (color == 16) {
        colorName = 'é€æ˜';
      } else {
        colorName = color + ' (' + getColorName(color) + ')';
      }
      document.getElementById('bgColorValue').textContent = colorName;
    }
    
    function updateLineColorValue() {
      const color = document.getElementById('lineColor').value;
      const colorName = getColorName(color);
      document.getElementById('lineColorValue').textContent = color + ' (' + colorName + ')';
    }
    
    function updateLineThicknessValue() {
      const thickness = document.getElementById('lineThickness').value;
      document.getElementById('lineThicknessValue').textContent = thickness + ' åƒç´ ';
    }
    
    function updateCircleBorderColorValue() {
      const color = document.getElementById('circleBorderColor').value;
      const colorName = getColorName(color);
      document.getElementById('circleBorderColorValue').textContent = color + ' (' + colorName + ')';
    }
    
    function updateCircleBorderThicknessValue() {
      const thickness = document.getElementById('circleBorderThickness').value;
      document.getElementById('circleBorderThicknessValue').textContent = thickness + ' åƒç´ ';
    }
    
    function updateCircleFillColorValue() {
      const color = document.getElementById('circleFillColor').value;
      const colorName = getColorName(color);
      document.getElementById('circleFillColorValue').textContent = color + ' (' + colorName + ')';
    }
    
    function updateRectBorderColorValue() {
      const color = document.getElementById('rectBorderColor').value;
      const colorName = getColorName(color);
      document.getElementById('rectBorderColorValue').textContent = color + ' (' + colorName + ')';
    }
    
    function updateRectBorderThicknessValue() {
      const thickness = document.getElementById('rectBorderThickness').value;
      document.getElementById('rectBorderThicknessValue').textContent = thickness + ' åƒç´ ';
    }
    
    function updateRectFillColorValue() {
      const color = document.getElementById('rectFillColor').value;
      const colorName = getColorName(color);
      document.getElementById('rectFillColorValue').textContent = color + ' (' + colorName + ')';
    }
    
    // æ¨£å¼è¨­å®šå‡½æ•¸
    function setStyle(styleName) {
      const styles = {
        'title': { fontSize: 4, textColor: 0, bgColor: 16 },
        'normal': { fontSize: 2, textColor: 0, bgColor: 16 },
        'highlight': { fontSize: 3, textColor: 15, bgColor: 0 },
        'subtitle': { fontSize: 3, textColor: 5, bgColor: 16 }
      };
      
      if (styles[styleName]) {
        document.getElementById('fontSize').value = styles[styleName].fontSize;
        document.getElementById('textColor').value = styles[styleName].textColor;
        document.getElementById('bgColor').value = styles[styleName].bgColor;
        
        updateFontSizeValue();
        updateTextColorValue();
        updateBgColorValue();
      }
    }
    
    // ç¹ªåœ–å‡½æ•¸ (æ¸¬è©¦ç‰ˆæœ¬)
    function drawText() {
      showTestAlert('æ–‡å­—ç¹ªè£½åŠŸèƒ½');
    }
    
    function drawMultiText() {
      showTestAlert('å¤šè¡Œæ–‡å­—ç¹ªè£½åŠŸèƒ½');
    }
    
    function drawLineAdvanced() {
      showTestAlert('é€²éšç•«ç·šåŠŸèƒ½');
    }
    
    function drawCircleAdvanced() {
      showTestAlert('é€²éšç•«åœ“åŠŸèƒ½');
    }
    
    function drawRectAdvanced() {
      showTestAlert('é€²éšç•«çŸ©å½¢åŠŸèƒ½');
    }
    
    function sendGrayscaleData() {
      showTestAlert('ç°éšåœ–ç‰‡æ•¸æ“šå‚³é€åŠŸèƒ½');
    }
    
    function clearGrayscaleData() {
      document.getElementById('grayscaleData').value = '';
      document.getElementById('grayscaleX').value = '0';
      document.getElementById('grayscaleY').value = '0';
      document.getElementById('grayscaleWidth').value = '100';
      document.getElementById('grayscaleHeight').value = '100';
    }
    
    // åœ–ç‰‡è½‰æ›å™¨ç›¸é—œè®Šæ•¸
    let currentWidth = 480;
    let currentHeight = 800;
    let imageCanvas = null;
    let imageCtx = null;
    let currentImageData = null;
    
    function initImageConverter() {
      imageCanvas = document.getElementById('imageCanvas');
      if (imageCanvas) {
        imageCtx = imageCanvas.getContext('2d');
        resetImageCanvas();
        
        // ç¶å®šäº‹ä»¶
        document.getElementById('imageInput').addEventListener('change', handleImageUpload);
        document.getElementById('widthSelect').addEventListener('change', updateCanvasSize);
        document.getElementById('heightSelect').addEventListener('change', updateCanvasSize);
        document.getElementById('converterDataTextarea').addEventListener('dblclick', copyConverterData);
      }
    }
    
    function updateCanvasSize() {
      currentWidth = parseInt(document.getElementById('widthSelect').value);
      currentHeight = parseInt(document.getElementById('heightSelect').value);
      
      if (imageCanvas) {
        imageCanvas.width = currentWidth;
        imageCanvas.height = currentHeight;
      }
      
      const totalPixels = currentWidth * currentHeight;
      document.getElementById('dataLabel').textContent = 
        `ç°éšæ•¸æ“š (${currentWidth}Ã—${currentHeight} = ${totalPixels.toLocaleString()} å€‹å€¼)ï¼š`;
      
      resetImageCanvas();
      updatePresetButtons();
    }
    
    function setPresetSize(width, height) {
      document.getElementById('widthSelect').value = width;
      document.getElementById('heightSelect').value = height;
      updateCanvasSize();
    }
    
    function updatePresetButtons() {
      const presetButtons = document.querySelectorAll('.preset-btn');
      presetButtons.forEach(btn => btn.classList.remove('active'));
      
      if (currentWidth === 64 && currentHeight === 64) {
        presetButtons[0].classList.add('active');
      } else if (currentWidth === 128 && currentHeight === 128) {
        presetButtons[1].classList.add('active');
      } else if (currentWidth === 320 && currentHeight === 240) {
        presetButtons[2].classList.add('active');
      } else if (currentWidth === 480 && currentHeight === 800) {
        presetButtons[3].classList.add('active');
      } else if (currentWidth === 540 && currentHeight === 960) {
        presetButtons[4].classList.add('active');
      } else if (currentWidth === 800 && currentHeight === 600) {
        presetButtons[5].classList.add('active');
      }
    }
    
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (file) {
        processImage(file);
      }
    }
    
    function processImage(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const img = new Image();
        
        img.onload = function() {
          resetImageCanvas();
          imageCtx.drawImage(img, 0, 0, currentWidth, currentHeight);
          
          const imageData = imageCtx.getImageData(0, 0, currentWidth, currentHeight);
          const grayscaleData = convertToGrayscale(imageData);
          
          drawGrayscaleImageToCanvas(grayscaleData);
          
          const dataString = grayscaleData.join(',');
          document.getElementById('converterDataTextarea').value = dataString;
          currentImageData = dataString;
          
          document.getElementById('canvasInfo').innerHTML = 
            `<strong>åœ–ç‰‡è³‡è¨Šï¼š</strong><br>
             åŸå§‹å°ºå¯¸: ${img.width} Ã— ${img.height}<br>
             è½‰æ›å°ºå¯¸: ${currentWidth} Ã— ${currentHeight}<br>
             æ•¸æ“šé»æ•¸: ${grayscaleData.length.toLocaleString()}<br>
             æª”æ¡ˆå¤§å°: ${(file.size / 1024).toFixed(1)} KB`;
          
          showToast('åœ–ç‰‡è½‰æ›å®Œæˆï¼');
        };
        
        img.src = e.target.result;
      };
      
      reader.readAsDataURL(file);
    }
    
    function convertToGrayscale(imageData) {
      const data = imageData.data;
      const grayscaleData = [];
      
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
        const grayscaleValue = Math.round((gray / 255) * 15);
        grayscaleData.push(grayscaleValue);
      }
      
      return grayscaleData;
    }
    
    function drawGrayscaleImageToCanvas(grayscaleData) {
      const imageData = imageCtx.createImageData(currentWidth, currentHeight);
      const data = imageData.data;
      
      for (let i = 0; i < grayscaleData.length; i++) {
        const grayValue = Math.round((grayscaleData[i] / 15) * 255);
        const pixelIndex = i * 4;
        
        data[pixelIndex] = grayValue;
        data[pixelIndex + 1] = grayValue;
        data[pixelIndex + 2] = grayValue;
        data[pixelIndex + 3] = 255;
      }
      
      imageCtx.putImageData(imageData, 0, 0);
    }
    
    function resetImageCanvas() {
      if (imageCtx) {
        imageCtx.fillStyle = '#ffffff';
        imageCtx.fillRect(0, 0, currentWidth, currentHeight);
      }
    }
    
    function copyConverterData() {
      const textarea = document.getElementById('converterDataTextarea');
      textarea.select();
      
      try {
        document.execCommand('copy');
        showToast('æ•¸æ“šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
      } catch (err) {
        showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½');
      }
    }
    
    function resetConverter() {
      document.getElementById('converterDataTextarea').value = '';
      document.getElementById('canvasInfo').textContent = 'è«‹å…ˆé¸æ“‡åœ–ç‰‡æª”æ¡ˆ';
      document.getElementById('imageInput').value = '';
      currentImageData = null;
      resetImageCanvas();
    }
    
    function downloadConverterData() {
      if (currentImageData) {
        const blob = new Blob([currentImageData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `epd_grayscale_data_${currentWidth}x${currentHeight}_${new Date().getTime()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('æ•¸æ“šæª”æ¡ˆä¸‹è¼‰å®Œæˆï¼');
      } else {
        showToast('è«‹å…ˆè½‰æ›åœ–ç‰‡ï¼');
      }
    }
    
    function showToast(message) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: opacity 0.3s;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }
    
    // æ™ºèƒ½åœ–ç‰‡æ§åˆ¶ç³»çµ±å‡½æ•¸
    function initImageControls() {
      console.log('åˆå§‹åŒ–æ™ºèƒ½åœ–ç‰‡æ§åˆ¶ç³»çµ±');
      updatePositionInfo();
    }
    
    function previewUploadedImage() {
      console.log('é–‹å§‹è™•ç†ä¸Šå‚³åœ–ç‰‡');
      var file = document.getElementById('uploadImageFile').files[0];
      if (!file) return;
      
      var reader = new FileReader();
      reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
          originalImage = img;
          console.log('åœ–ç‰‡è¼‰å…¥å®Œæˆ:', img.width + 'x' + img.height);
          
          document.getElementById('imgWidth').value = Math.min(img.width, 540);
          document.getElementById('imgHeight').value = Math.min(img.height, 960);
          
          document.getElementById('positionControls').style.display = 'block';
          document.getElementById('effectControls').style.display = 'block';
          document.getElementById('sendImageBtn').disabled = false;
          document.getElementById('imagePreview').style.display = 'block';
          
          updatePositionInfo();
          processImageForPreview();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    function processImageForPreview() {
      if (!originalImage) return;
      
      var canvas = document.getElementById('imagePreviewCanvas');
      if (!canvas) return;
      
      var ctx = canvas.getContext('2d');
      var w = parseInt(document.getElementById('imgWidth').value);
      var h = parseInt(document.getElementById('imgHeight').value);
      
      canvas.width = w;
      canvas.height = h;
      
      ctx.drawImage(originalImage, 0, 0, w, h);
      smartImageData = ctx.getImageData(0, 0, w, h);
      console.log('åœ–ç‰‡è™•ç†å®Œæˆ:', w + 'x' + h);
      
      applyImageAdjustments();
    }
    
    function applyImageAdjustments() {
      if (!smartImageData) return;
      
      var canvas = document.getElementById('imagePreviewCanvas');
      if (!canvas) return;
      
      var ctx = canvas.getContext('2d');
      var contrast = parseFloat(document.getElementById('contrast').value) / 100;
      var brightness = parseFloat(document.getElementById('brightness').value);
      
      var imageData = ctx.createImageData(smartImageData.width, smartImageData.height);
      var srcData = smartImageData.data;
      var destData = imageData.data;
      
      for (var i = 0; i < srcData.length; i += 4) {
        var gray = srcData[i] * 0.299 + srcData[i+1] * 0.587 + srcData[i+2] * 0.114;
        gray = (gray - 128) * contrast + 128 + brightness;
        gray = Math.max(0, Math.min(255, gray));
        
        var gray16 = Math.floor(gray / 16);
        gray16 = Math.max(0, Math.min(15, gray16));
        var displayGray = gray16 * 17;
        
        destData[i] = destData[i+1] = destData[i+2] = displayGray;
        destData[i+3] = 255;
      }
      
      ctx.putImageData(imageData, 0, 0);
    }
    
    function updatePositionInfo() {
      var x = parseInt(document.getElementById('imgX').value) || 0;
      var y = parseInt(document.getElementById('imgY').value) || 0;
      var w = parseInt(document.getElementById('imgWidth').value) || 100;
      var h = parseInt(document.getElementById('imgHeight').value) || 100;
      
      var info = 'ä½ç½®: (' + x + ', ' + y + ') å°ºå¯¸: ' + w + ' x ' + h + ' åƒç´ ';
      if (x + w > 540 || y + h > 960) {
        info += ' âš ï¸ è¶…å‡ºè¢å¹•ç¯„åœ!';
      }
      
      if (document.getElementById('positionInfo')) {
        document.getElementById('positionInfo').textContent = info;
      }
      
      if (originalImage) {
        processImageForPreview();
      }
    }
    
    function updateImagePreview() {
      updatePositionInfo();
    }
    
    function updateContrast() {
      var contrast = document.getElementById('contrast').value;
      document.getElementById('contrastValue').textContent = contrast + '%';
      if (smartImageData) {
        applyImageAdjustments();
      }
    }
    
    function updateBrightness() {
      var brightness = document.getElementById('brightness').value;
      document.getElementById('brightnessValue').textContent = brightness;
      if (smartImageData) {
        applyImageAdjustments();
      }
    }
    
    function updateGrayLevels() {
      var levels = document.getElementById('grayLevels').value;
      document.getElementById('grayLevelsValue').textContent = levels + 'ç´š';
      if (smartImageData) {
        applyImageAdjustments();
      }
    }
    
    function invertColors() {
      var contrast = document.getElementById('contrast');
      var brightness = document.getElementById('brightness');
      
      contrast.value = 200 - parseInt(contrast.value);
      brightness.value = -parseInt(brightness.value);
      
      updateContrast();
      updateBrightness();
    }
    
    function resetEffects() {
      document.getElementById('contrast').value = 100;
      document.getElementById('brightness').value = 0;
      document.getElementById('grayLevels').value = 16;
      
      updateContrast();
      updateBrightness();
      updateGrayLevels();
    }
    
    function fitToScreen() {
      if (!originalImage) {
        alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡');
        return;
      }
      
      var scaleX = 540 / originalImage.width;
      var scaleY = 960 / originalImage.height;
      var scale = Math.min(scaleX, scaleY);
      
      document.getElementById('imgWidth').value = Math.floor(originalImage.width * scale);
      document.getElementById('imgHeight').value = Math.floor(originalImage.height * scale);
      updatePositionInfo();
    }
    
    function keepAspectRatio() {
      if (!originalImage) return;
      
      var w = parseInt(document.getElementById('imgWidth').value);
      var ratio = originalImage.height / originalImage.width;
      
      document.getElementById('imgHeight').value = Math.floor(w * ratio);
      updatePositionInfo();
    }
    
    function centerImage() {
      var w = parseInt(document.getElementById('imgWidth').value);
      var h = parseInt(document.getElementById('imgHeight').value);
      
      document.getElementById('imgX').value = Math.floor((540 - w) / 2);
      document.getElementById('imgY').value = Math.floor((960 - h) / 2);
      updatePositionInfo();
    }
    
    function sendImageToEPD() {
      showTestAlert('æ™ºèƒ½åœ–ç‰‡ä¸Šå‚³åˆ° EPD åŠŸèƒ½');
    }
    
    // åˆå§‹åŒ–æ‰€æœ‰é¡¯ç¤ºå€¼
    function initializeValues() {
      updateTextColorValue();
      updateBgColorValue();
      updateFontSizeValue();
      updateLineColorValue();
      updateLineThicknessValue();
      updateCircleBorderColorValue();
      updateCircleBorderThicknessValue();
      updateCircleFillColorValue();
      updateRectBorderColorValue();
      updateRectBorderThicknessValue();
      updateRectFillColorValue();
      updateBrushSize();
      updateBrushColor();
      updateContrast();
      updateBrightness();
      updateGrayLevels();
    }
    
    // é é¢è¼‰å…¥å®Œæˆåˆå§‹åŒ–
    window.onload = function() {
      initCanvas();
      initImageConverter();
      initImageControls();
      initializeValues();
      
      console.log('EPD Controller Test Page - All systems initialized');
      showToast('ç¶²é æ¸¬è©¦ç‰ˆæœ¬è¼‰å…¥å®Œæˆï¼æ‰€æœ‰ç¶²è·¯åŠŸèƒ½ä»¥æç¤ºä»£æ›¿ã€‚');
    };
  </script>
</body>
</html>